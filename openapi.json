{
  "openapi": "3.1.0",
  "info": {
    "title": "Planner GPT Capabilities",
    "version": "0.3.0",
    "description": "Production endpoints for health, zoning (ArcGIS + BC Geocoder), and DPA4 Coal Mine Risk."
  },
  "servers": [
    { "url": "https://planner-gpt-capabilities.vercel.app" }
  ],
  "paths": {
    "/api/health": {
      "get": {
        "operationId": "health",
        "summary": "Health check",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/HealthResponse" }
              }
            }
          }
        }
      }
    },
    "/api/zoning": {
      "get": {
        "operationId": "zoningLookup",
        "summary": "Lookup zoning for a point or address (Nanaimo ArcGIS)",
        "parameters": [
          { "name": "address", "in": "query", "required": false, "schema": { "type": "string" }, "description": "Street address (BC Geocoder used if lat/lon not provided)" },
          { "name": "lat", "in": "query", "required": false, "schema": { "type": "number" }, "description": "Latitude (WGS84)" },
          { "name": "lon", "in": "query", "required": false, "schema": { "type": "number" }, "description": "Longitude (WGS84)" },
          { "name": "select", "in": "query", "required": false, "schema": { "type": "string" }, "description": "CSV of fields to include (e.g., zoningDistrict,zoningName,category)" },
          { "name": "debug", "in": "query", "required": false, "schema": { "type": "string", "enum": ["0","1"] }, "description": "If '1', include meta.debug attributes" },
          { "name": "includeRaw", "in": "query", "required": false, "schema": { "type": "string", "enum": ["0","1"] }, "description": "If '1' and debug=1, include raw ArcGIS response" }
        ],
        "responses": {
          "200": {
            "description": "Zoning result",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ZoningResponse" },
                "examples": {
                  "ok": {
                    "value": {
                      "ok": true,
                      "capability": "zoning",
                      "input": { "address": "455 Wallace St Nanaimo BC", "lat": 49.1639, "lon": -123.938 },
                      "data": {
                        "parcelCentroid": { "lat": 49.1639, "lon": -123.938 },
                        "zoningDistrict": "DT7",
                        "zoningName": "Quennel Square",
                        "category": "Downtown",
                        "source": "https://nanmap.nanaimo.ca/arcgis/rest/services/NanMap/Zoning/MapServer/1"
                      },
                      "attribution": [
                        { "name": "BC Address Geocoder", "url": "https://geocoder.api.gov.bc.ca/" },
                        { "name": "City of Nanaimo GIS", "url": "https://nanmap.nanaimo.ca/arcgis/rest/services/NanMap/Zoning/MapServer" }
                      ],
                      "meta": { "version": "0.2" }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } }
          },
          "422": {
            "description": "Geocode failed",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } }
          }
        }
      }
    },
    "/api/dpa4": {
      "get": {
        "operationId": "dpa4Lookup",
        "summary": "Check if a point/address is within DPA4 (Abandoned Mine Workings Hazard – Coal Mine Risk)",
        "parameters": [
          { "name": "address", "in": "query", "required": false, "schema": { "type": "string" }, "description": "Street address (BC Geocoder used if lat/lon not provided)" },
          { "name": "lat", "in": "query", "required": false, "schema": { "type": "number" } },
          { "name": "lon", "in": "query", "required": false, "schema": { "type": "number" } },
          { "name": "debug", "in": "query", "required": false, "schema": { "type": "string", "enum": ["0","1"] }, "description": "If '1', include meta.debug and raw ArcGIS attributes" }
        ],
        "responses": {
          "200": {
            "description": "DPA4 result",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/DPA4Response" },
                "examples": {
                  "inside": {
                    "value": {
                      "ok": true,
                      "capability": "dpa4",
                      "input": { "address": "25 Victoria Rd Nanaimo BC", "lat": 49.1611, "lon": -123.9347 },
                      "data": {
                        "parcelCentroid": { "lat": 49.1611, "lon": -123.9347 },
                        "inside": true,
                        "dpaCode": "DPA4",
                        "dpaName": "Abandoned Mine Workings Hazard – Coal Mine Risk",
                        "notes": null,
                        "source": "https://nanmap.nanaimo.ca/arcgis/rest/services/NanMap/CityPlan2022/MapServer/77"
                      },
                      "attribution": [
                        { "name": "BC Address Geocoder", "url": "https://geocoder.api.gov.bc.ca/" },
                        { "name": "City of Nanaimo GIS", "url": "https://nanmap.nanaimo.ca/arcgis/rest/services/NanMap/CityPlan2022/MapServer" }
                      ],
                      "meta": { "version": "0.2" }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } }
          },
          "422": {
            "description": "Geocode failed",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "HealthResponse": {
        "type": "object",
        "properties": {
          "ok": { "type": "boolean" },
          "capability": { "type": "string" },
          "data": {
            "type": "object",
            "properties": {
              "status": { "type": "string" },
              "now": { "type": "string", "format": "date-time" }
            },
            "required": ["status", "now"]
          }
        },
        "required": ["ok", "capability", "data"]
      },
      "Attribution": {
        "type": "object",
        "properties": {
          "name": { "type": "string" },
          "url": { "type": "string", "format": "uri" }
        }
      },
      "Point": {
        "type": "object",
        "properties": { "lat": { "type": "number" }, "lon": { "type": "number" } },
        "required": ["lat", "lon"]
      },
      "ZoningResponse": {
        "type": "object",
        "properties": {
          "ok": { "type": "boolean" },
          "capability": { "type": "string", "const": "zoning" },
          "input": { "type": "object", "additionalProperties": true },
          "data": {
            "type": "object",
            "properties": {
              "parcelCentroid": { "$ref": "#/components/schemas/Point" },
              "zoningDistrict": { "type": "string", "nullable": true },
              "zoningName": { "type": "string", "nullable": true },
              "category": { "type": "string", "nullable": true },
              "bylawId": { "type": "string", "nullable": true },
              "source": { "type": "string" }
            },
            "required": ["parcelCentroid", "source"]
          },
          "attribution": { "type": "array", "items": { "$ref": "#/components/schemas/Attribution" } },
          "meta": { "type": "object", "additionalProperties": true }
        },
        "required": ["ok", "capability", "data"]
      },
      "DPA4Response": {
        "type": "object",
        "properties": {
          "ok": { "type": "boolean" },
          "capability": { "type": "string", "const": "dpa4" },
          "input": { "type": "object", "additionalProperties": true },
          "data": {
            "type": "object",
            "properties": {
              "parcelCentroid": { "$ref": "#/components/schemas/Point" },
              "inside": { "type": "boolean", "description": "True if location intersects DPA4 Coal Mine Risk polygon." },
              "dpaCode": { "type": "string", "nullable": true },
              "dpaName": { "type": "string", "nullable": true },
              "notes": { "type": "string", "nullable": true },
              "source": { "type": "string" }
            },
            "required": ["parcelCentroid", "inside", "source"]
          },
          "attribution": { "type": "array", "items": { "$ref": "#/components/schemas/Attribution" } },
          "meta": { "type": "object", "additionalProperties": true }
        },
        "required": ["ok", "capability", "data"]
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "ok": { "type": "boolean", "const": false },
          "capability": { "type": "string" },
          "error": {
            "type": "object",
            "properties": {
              "code": { "type": "string" },
              "message": { "type": "string" }
            },
            "required": ["code", "message"]
          }
        },
        "required": ["ok", "capability", "error"]
      }
    }
  }
}
